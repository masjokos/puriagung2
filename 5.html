<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Warga - Puri Agung 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        :root { --primary: #4f46e5; --bg-main: #f8fafc; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--bg-main); color: #1e293b; }
        .card-shadow { box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); }
        .bottom-nav-item.active { color: var(--primary); }
        .loader { border-top-color: var(--primary); animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-blur { backdrop-filter: blur(8px); }
        body.modal-open { overflow: hidden; }
        input:read-only { background-color: transparent; border: none; pointer-events: none; }
    </style>
</head>
<body class="overflow-x-hidden pb-20 lg:pb-0">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-[200] bg-white/80 modal-blur flex flex-col items-center justify-center hidden">
        <div class="loader ease-linear rounded-full border-4 border-slate-100 h-12 w-12 mb-4"></div>
        <h3 class="text-indigo-600 font-bold animate-pulse" id="loadingText">Memproses...</h3>
    </div>

    <!-- Modal Detail & Edit Warga -->
    <div id="modalDetail" class="fixed inset-0 z-[150] hidden flex items-center justify-center p-4 bg-slate-900/60 modal-blur" onclick="closeModal()">
        <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-[2rem] card-shadow overflow-y-auto" onclick="event.stopPropagation()">
            <!-- Header Modal -->
            <div class="sticky top-0 z-10 bg-indigo-600 p-6 flex justify-between items-center text-white">
                <div class="flex items-center gap-3">
                    <button onclick="closeModal()" class="w-8 h-8 flex items-center justify-center hover:bg-white/20 rounded-full transition">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                    </button>
                    <h3 class="text-lg font-extrabold" id="modalTitle">Detail Profil</h3>
                </div>
                <div class="flex gap-2">
                    <button id="btnEdit" onclick="toggleEditMode()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-xl flex items-center gap-2 text-sm font-bold transition">
                        <i data-lucide="edit-3" class="w-4 h-4"></i> Edit
                    </button>
                    <button id="btnSaveEdit" onclick="saveWargaEdit()" class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 rounded-xl flex items-center gap-2 text-sm font-bold transition hidden">
                        <i data-lucide="check" class="w-4 h-4"></i> Simpan
                    </button>
                    <button onclick="closeModal()" class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 md:p-8">
                <!-- Info Utama -->
                <div class="bg-white rounded-3xl p-6 shadow-lg border border-slate-50 flex flex-col md:flex-row gap-6 -mt-12 relative z-20">
                    <div class="w-20 h-20 bg-indigo-100 rounded-2xl flex-shrink-0 flex items-center justify-center text-indigo-600">
                        <i data-lucide="user" class="w-10 h-10"></i>
                    </div>
                    <div class="flex-1 space-y-2">
                        <input type="text" id="editNama" class="text-2xl font-extrabold text-slate-900 w-full outline-none focus:ring-2 focus:ring-indigo-100 rounded-lg px-2" value="-" readonly>
                        <div class="flex items-center gap-2 text-slate-400 font-mono text-sm">
                            <span>NIK:</span>
                            <input type="text" id="editNik" class="w-full outline-none focus:ring-2 focus:ring-indigo-100 rounded px-2" value="-" readonly>
                        </div>
                        <div class="flex flex-wrap gap-2 mt-1" id="detailBadges"></div>
                    </div>
                </div>

                <!-- Grid Data Detail -->
                <form id="editForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8">
                    <!-- Fields will be injected here -->
                </form>

                <div id="detailFamilySection" class="mt-8 border-t border-slate-100 pt-6 hidden">
                    <h5 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-widest">Anggota Keluarga</h5>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="detailFamilyGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-[#1e1b4b] p-4">
        <div class="w-full max-w-md bg-white rounded-[2.5rem] shadow-2xl p-8 md:p-12">
            <div class="text-center mb-10">
                <div class="w-16 h-16 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center mx-auto mb-4 rotate-3">
                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                </div>
                <h1 class="text-2xl font-extrabold text-slate-900">Sistem Warga</h1>
                <p class="text-slate-400 text-sm">Puri Agung 2 - Admin Portal</p>
            </div>
            <form id="loginForm" class="space-y-5">
                <input type="text" id="username" class="w-full px-6 py-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Username" required>
                <input type="password" id="password" class="w-full px-6 py-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Password" required>
                <div id="loginError" class="hidden text-red-500 text-xs font-bold text-center">Username/Password salah</div>
                <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition">Masuk</button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden min-h-screen flex flex-col lg:flex-row">
        <!-- Sidebar (Desktop) -->
        <aside class="hidden lg:flex w-72 bg-white border-r border-slate-100 flex-col p-8 sticky top-0 h-screen">
            <div class="flex items-center gap-3 mb-10">
                <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white"><i data-lucide="home" class="w-6 h-6"></i></div>
                <span class="font-extrabold text-xl">Puri Agung 2</span>
            </div>
            <nav class="space-y-2 flex-1">
                <button onclick="showPage('dashboard')" class="nav-item w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-slate-500 active" data-page="dashboard"><i data-lucide="layout-grid"></i> Beranda</button>
                <button onclick="showPage('dataWarga')" class="nav-item w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-slate-500" data-page="dataWarga"><i data-lucide="users"></i> Data Warga</button>
                <button onclick="showPage('kepalaKeluarga')" class="nav-item w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-slate-500" data-page="kepalaKeluarga"><i data-lucide="user-square"></i> Kepala Keluarga</button>
                <button onclick="showPage('formWarga')" class="nav-item w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold text-slate-500" data-page="formWarga"><i data-lucide="user-plus"></i> Tambah</button>
            </nav>
            <button onclick="logout()" class="flex items-center gap-4 px-6 py-4 text-red-500 font-bold"><i data-lucide="log-out"></i> Keluar</button>
        </aside>

        <!-- Bottom Nav (Mobile) -->
        <nav class="lg:hidden fixed bottom-0 inset-x-0 bg-white border-t p-3 z-[60] flex justify-around rounded-t-3xl shadow-up">
            <button onclick="showPage('dashboard')" class="bottom-nav-item flex flex-col items-center gap-1 text-slate-400 active" data-page="dashboard"><i data-lucide="layout-grid"></i></button>
            <button onclick="showPage('dataWarga')" class="bottom-nav-item flex flex-col items-center gap-1 text-slate-400" data-page="dataWarga"><i data-lucide="users"></i></button>
            <button onclick="showPage('formWarga')" class="bottom-nav-item -mt-8 flex flex-col items-center"><div class="w-12 h-12 bg-indigo-600 text-white rounded-full flex items-center justify-center border-4 border-white shadow-lg"><i data-lucide="plus"></i></div></button>
            <button onclick="showPage('kepalaKeluarga')" class="bottom-nav-item flex flex-col items-center gap-1 text-slate-400" data-page="kepalaKeluarga"><i data-lucide="user-square"></i></button>
            <button onclick="logout()" class="bottom-nav-item flex flex-col items-center gap-1 text-slate-400"><i data-lucide="log-out"></i></button>
        </nav>

        <!-- Content Area -->
        <div class="flex-1 flex flex-col min-w-0">
            <header class="p-6 border-b bg-white/70 backdrop-blur sticky top-0 z-30 flex justify-between items-center">
                <h2 id="pageTitle" class="text-xl font-extrabold">Dashboard</h2>
                <div class="flex items-center gap-2"><div class="text-right hidden sm:block text-xs font-bold text-slate-700">Admin</div><div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center font-bold">AD</div></div>
            </header>

            <div class="p-6 space-y-8">
                <!-- Page Dashboard -->
                <div id="page-dashboard" class="page-content space-y-6">
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4" id="statGrid"></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white p-6 rounded-3xl card-shadow h-64"><canvas id="chartRT"></canvas></div>
                        <div class="bg-white p-6 rounded-3xl card-shadow"><h4 class="font-bold mb-4">Warga Terbaru</h4><div id="recentWargaList" class="space-y-3"></div></div>
                    </div>
                </div>

                <!-- Page Data Warga -->
                <div id="page-dataWarga" class="page-content hidden space-y-4">
                    <div class="bg-white p-4 rounded-2xl flex items-center gap-3 border"><i data-lucide="search" class="text-slate-300"></i><input type="text" id="searchWarga" oninput="filterData('warga')" class="w-full outline-none" placeholder="Cari warga..."></div>
                    <div class="bg-white rounded-2xl border overflow-hidden overflow-x-auto"><table class="w-full text-left"><thead class="bg-slate-50 text-[10px] font-bold text-slate-400 uppercase"><tr class="border-b"><th class="p-4">Warga</th><th class="p-4">Lokasi</th><th class="p-4 text-right">Aksi</th></tr></thead><tbody id="wargaTableBody" class="divide-y"></tbody></table></div>
                </div>

                <!-- Page KK -->
                <div id="page-kepalaKeluarga" class="page-content hidden space-y-4">
                    <input type="text" id="searchKK" oninput="filterData('kk')" class="w-full p-4 bg-white border rounded-2xl outline-none" placeholder="Cari Kepala Keluarga...">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="kkContainer"></div>
                </div>

                <!-- Page Form -->
                <div id="page-formWarga" class="page-content hidden">
                    <form id="addWargaForm" class="max-w-2xl mx-auto bg-white p-8 rounded-3xl border space-y-4">
                        <h3 class="font-bold text-lg mb-4">Input Data Baru</h3>
                        <input type="text" name="Nama" placeholder="Nama Lengkap" class="w-full p-4 bg-slate-50 rounded-xl outline-none" required>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="number" name="NIK" placeholder="NIK" class="p-4 bg-slate-50 rounded-xl outline-none" required>
                            <input type="number" name="No KK" placeholder="No KK" class="p-4 bg-slate-50 rounded-xl outline-none" required>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-xl shadow-lg">Simpan Warga</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz3qxTEDd47HifJz4bBQaRELeavO00j8-paFtgP3CeqId5DcAHTZeTZy3SQYAzwmEV1MQ/exec';
        let dbWarga = [], dbUsers = [], charts = {};
        let isEditMode = false;
        let currentWargaNik = "";

        const getVal = (obj, key) => {
            if (!obj) return "";
            const k = Object.keys(obj).find(x => x.toLowerCase() === key.toLowerCase());
            return k ? String(obj[k]).trim() : "";
        };

        const fetchAPI = async (action, payload = null) => {
            let url = `${WEB_APP_URL}?action=${action}&t=${Date.now()}`;
            if(payload) {
                // Untuk update, kita gunakan method POST jika memungkinkan atau query string jika script GS hanya mendukung GET
                // Di sini kita asumsikan script mendukung GET dengan parameter data
                const params = new URLSearchParams(payload).toString();
                url += `&${params}`;
            }
            try {
                const res = await fetch(url);
                return await res.json();
            } catch (e) { return null; }
        };

        const showPage = (id) => {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById('page-' + id).classList.remove('hidden');
            document.getElementById('pageTitle').innerText = id.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            document.querySelectorAll('.nav-item, .bottom-nav-item').forEach(n => n.classList.toggle('active', n.dataset.page === id));
        };

        const openWargaDetail = (nik) => {
            const w = dbWarga.find(x => getVal(x, 'nik') === String(nik));
            if(!w) return;

            currentWargaNik = nik;
            isEditMode = false;
            updateModalUI();

            document.getElementById('editNama').value = getVal(w, 'nama');
            document.getElementById('editNik').value = getVal(w, 'nik');
            
            document.getElementById('detailBadges').innerHTML = `
                <span class="px-2 py-1 bg-indigo-50 text-indigo-600 rounded-lg text-[10px] font-bold uppercase">${getVal(w, 'status keluarga')}</span>
                <span class="px-2 py-1 bg-emerald-50 text-emerald-600 rounded-lg text-[10px] font-bold uppercase">${getVal(w, 'status tinggal')}</span>
            `;

            const fields = [
                {l:'No KK', v:getVal(w, 'no kk'), i:'credit-card', k:'No KK'},
                {l:'Blok', v:getVal(w, 'blok'), i:'map', k:'Blok'},
                {l:'Nomer', v:getVal(w, 'nomer'), i:'hash', k:'Nomer'},
                {l:'RT', v:getVal(w, 'rt'), i:'navigation', k:'RT'},
                {l:'Tgl Lahir', v:getVal(w, 'tanggal lahir'), i:'calendar', k:'Tanggal Lahir'},
                {l:'Pekerjaan', v:getVal(w, 'pekerjaan'), i:'briefcase', k:'Pekerjaan'},
                {l:'Status Keluarga', v:getVal(w, 'status keluarga'), i:'users-2', k:'Status Keluarga'},
                {l:'Status Tinggal', v:getVal(w, 'status tinggal'), i:'home', k:'Status Tinggal'}
            ];

            document.getElementById('editForm').innerHTML = fields.map(f => `
                <div class="flex flex-col gap-1 p-3 bg-slate-50 rounded-2xl border border-transparent transition-all focus-within:border-indigo-200 focus-within:bg-white focus-within:shadow-sm">
                    <div class="flex items-center gap-2">
                        <i data-lucide="${f.i}" class="w-3 h-3 text-slate-400"></i>
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-tight">${f.l}</label>
                    </div>
                    <input type="text" name="${f.k}" value="${f.v}" readonly 
                           class="text-xs font-bold text-slate-800 bg-transparent outline-none w-full px-1 py-0.5 rounded focus:ring-1 focus:ring-indigo-100">
                </div>
            `).join('');

            const fam = dbWarga.filter(x => getVal(x, 'no kk') === getVal(w, 'no kk') && getVal(x, 'nik') !== getVal(w, 'nik'));
            const famSec = document.getElementById('detailFamilySection');
            famSec.classList.toggle('hidden', fam.length === 0);
            document.getElementById('detailFamilyGrid').innerHTML = fam.map(a => `
                <div onclick="openWargaDetail('${getVal(a, 'nik')}')" class="p-3 bg-slate-50 rounded-xl cursor-pointer hover:bg-indigo-50 transition border border-transparent hover:border-indigo-100">
                    <p class="text-xs font-bold truncate">${getVal(a, 'nama')}</p>
                    <p class="text-[9px] font-bold text-slate-400 uppercase">${getVal(a, 'status keluarga')}</p>
                </div>
            `).join('');

            document.getElementById('modalDetail').classList.remove('hidden');
            document.body.classList.add('modal-open');
            lucide.createIcons();
        };

        const toggleEditMode = () => {
            isEditMode = !isEditMode;
            updateModalUI();
        };

        const updateModalUI = () => {
            const inputs = document.querySelectorAll('#modalDetail input');
            const btnEdit = document.getElementById('btnEdit');
            const btnSave = document.getElementById('btnSaveEdit');
            const title = document.getElementById('modalTitle');

            title.innerText = isEditMode ? "Edit Profil Warga" : "Detail Profil";
            btnEdit.classList.toggle('hidden', isEditMode);
            btnSave.classList.toggle('hidden', !isEditMode);

            inputs.forEach(inp => {
                if (inp.id === 'editNik' && isEditMode) return; // NIK biasanya tidak diubah karena primary key
                inp.readOnly = !isEditMode;
                if (isEditMode) {
                    inp.parentElement.classList.add('ring-1', 'ring-indigo-100', 'bg-white');
                } else {
                    inp.parentElement.classList.remove('ring-1', 'ring-indigo-100', 'bg-white');
                }
            });
        };

        const saveWargaEdit = async () => {
            const formData = new FormData(document.getElementById('editForm'));
            const data = Object.fromEntries(formData.entries());
            data.Nama = document.getElementById('editNama').value;
            data.NIK = document.getElementById('editNik').value;

            setLoading(true, "Menyimpan Perubahan...");
            
            // Simulasikan Update (Karena script Google Apps Script butuh parameter spesifik)
            // Di sini kita mengirim parameter action 'updateWarga' 
            const result = await fetchAPI('updateWarga', data);
            
            if (result && result.status === "success") {
                await syncData(); // Refresh data lokal
                isEditMode = false;
                updateModalUI();
                setLoading(false);
            } else {
                setLoading(false);
                alert("Gagal menyimpan data. Pastikan koneksi internet stabil.");
            }
        };

        const closeModal = () => {
            document.getElementById('modalDetail').classList.add('hidden');
            document.body.classList.remove('modal-open');
        };

        const renderTable = (data) => {
            document.getElementById('wargaTableBody').innerHTML = data.map(w => `
                <tr class="hover:bg-slate-50 cursor-pointer transition" onclick="openWargaDetail('${getVal(w, 'nik')}')">
                    <td class="p-4"><p class="font-bold text-sm text-slate-800">${getVal(w, 'nama')}</p><p class="text-[10px] text-slate-400 font-mono">${getVal(w, 'nik')}</p></td>
                    <td class="p-4"><p class="text-xs font-bold text-slate-600">Blok ${getVal(w, 'blok')} No. ${getVal(w, 'nomer')}</p><p class="text-[10px] text-slate-400 uppercase">RT ${getVal(w, 'rt')}</p></td>
                    <td class="p-4 text-right">
                        <div class="flex items-center justify-end gap-2">
                             <button class="w-8 h-8 rounded-lg bg-slate-50 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 flex items-center justify-center transition">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                             </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        };

        const filterData = (type) => {
            const q = document.getElementById(type === 'warga' ? 'searchWarga' : 'searchKK').value.toLowerCase();
            const filtered = dbWarga.filter(w => getVal(w, 'nama').toLowerCase().includes(q) || getVal(w, 'nik').includes(q) || getVal(w, 'no kk').includes(q));
            type === 'warga' ? renderTable(filtered) : renderKK(filtered);
        };

        const renderKK = (data) => {
            const listKK = data.filter(w => getVal(w, 'status keluarga').toLowerCase().includes('kepala'));
            document.getElementById('kkContainer').innerHTML = listKK.map(kk => {
                const count = dbWarga.filter(x => getVal(x, 'no kk') === getVal(kk, 'no kk')).length;
                return `
                <div class="bg-white p-5 rounded-3xl border hover:border-indigo-200 cursor-pointer transition shadow-sm hover:shadow-md" onclick="openWargaDetail('${getVal(kk, 'nik')}')">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-10 h-10 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center"><i data-lucide="user-square"></i></div>
                        <span class="px-3 py-1 bg-indigo-600 text-white rounded-full text-[9px] font-bold uppercase tracking-wider">${count} Anggota</span>
                    </div>
                    <h4 class="font-bold text-slate-800 truncate">${getVal(kk, 'nama')}</h4>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">NO KK: ${getVal(kk, 'no kk')}</p>
                </div>
            `;
            }).join('');
            lucide.createIcons();
        };

        const syncData = async () => {
            setLoading(true, "Sinkronisasi Data...");
            const data = await fetchAPI('getWarga');
            if(data) {
                dbWarga = data;
                renderTable(dbWarga);
                renderKK(dbWarga);
                updateStats();
                updateChart();
            }
            setLoading(false);
        };

        const updateStats = () => {
            const stats = [
                {l:'Total Warga', v:dbWarga.length, i:'users', c:'indigo'},
                {l:'Rumah Isi', v:new Set(dbWarga.map(w => getVal(w, 'blok')+getVal(w, 'nomer'))).size, i:'home', c:'emerald'},
                {l:'Warga Tetap', v:dbWarga.filter(w => getVal(w, 'status tinggal') === 'Tetap').length, i:'user-check', c:'blue'},
                {l:'Warga Kontrak', v:dbWarga.filter(w => getVal(w, 'status tinggal') === 'Kontrak').length, i:'user-minus', c:'amber'}
            ];
            document.getElementById('statGrid').innerHTML = stats.map(s => `
                <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm">
                    <div class="w-8 h-8 bg-${s.c}-50 text-${s.c}-600 rounded-xl flex items-center justify-center mb-3"><i data-lucide="${s.i}" class="w-4 h-4"></i></div>
                    <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">${s.l}</p>
                    <h3 class="text-xl font-extrabold text-slate-800">${s.v}</h3>
                </div>
            `).join('');
            
            const latest = [...dbWarga].reverse().slice(0, 4);
            document.getElementById('recentWargaList').innerHTML = latest.map(w => `
                <div class="flex items-center gap-3 p-3 bg-slate-50 hover:bg-white border border-transparent hover:border-slate-100 rounded-2xl cursor-pointer transition shadow-sm" onclick="openWargaDetail('${getVal(w, 'nik')}')">
                    <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-indigo-500 border border-slate-100 shadow-sm"><i data-lucide="user" class="w-5 h-5"></i></div>
                    <div class="flex-1 min-w-0"><p class="text-xs font-bold text-slate-800 truncate">${getVal(w, 'nama')}</p><p class="text-[9px] font-bold text-slate-400">Blok ${getVal(w, 'blok')} - RT ${getVal(w, 'rt')}</p></div>
                    <i data-lucide="chevron-right" class="w-3 h-3 text-slate-300"></i>
                </div>
            `).join('');
            lucide.createIcons();
        };

        const updateChart = () => {
            const rtCounts = {};
            dbWarga.forEach(w => { const rt = getVal(w, 'rt'); if(rt) rtCounts[rt] = (rtCounts[rt] || 0) + 1; });
            if(charts.rt) charts.rt.destroy();
            const ctx = document.getElementById('chartRT').getContext('2d');
            charts.rt = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(rtCounts).sort().map(k => `RT ${k}`),
                    datasets: [{ label: 'Warga', data: Object.keys(rtCounts).sort().map(k => rtCounts[k]), backgroundColor: '#6366f1', borderRadius: 8, barThickness: 20 }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } } 
                }
            });
        };

        const setLoading = (s, t) => {
            const l = document.getElementById('loadingOverlay');
            l.classList.toggle('hidden', !s);
            if(t) document.getElementById('loadingText').innerText = t;
        };

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value, p = document.getElementById('password').value;
            const user = dbUsers.find(x => getVal(x, 'username') === u && getVal(x, 'password') === p);
            if(user) {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                syncData();
            } else {
                document.getElementById('loginError').classList.remove('hidden');
            }
        };

        document.getElementById('addWargaForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            setLoading(true, "Menambahkan Warga...");
            const res = await fetchAPI('addWarga', data);
            if(res && res.status === "success") {
                e.target.reset();
                showPage('dataWarga');
                await syncData();
            } else {
                alert("Gagal menambahkan data.");
            }
            setLoading(false);
        };

        const init = async () => {
            setLoading(true, "Menghubungkan Server...");
            const users = await fetchAPI('getUsers');
            if(users) dbUsers = users;
            setLoading(false);
            lucide.createIcons();
        };

        const logout = () => location.reload();
        init();
    </script>
</body>
</html>
