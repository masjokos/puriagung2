<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Warga - Manajemen Data Terintegrasi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    
    :root {
      --primary: #4f46e5;
      --secondary: #0ea5e9;
      --accent: #f43f5e;
      --bg: #f8fafc;
    }

    body { 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      background-color: var(--bg); 
      margin: 0; 
      padding: 0; 
      color: #1e293b;
    }

    .page { display: none; }
    .page.active { display: block; animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    
    @keyframes slideUp { 
      from { opacity: 0; transform: translateY(20px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 1.5rem; left: 1rem; right: 1rem;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0.75rem;
      border-radius: 2rem;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
      z-index: 100;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .nav-item { color: #94a3b8; transition: all 0.3s ease; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; border: none; background: none; cursor: pointer; }
    .nav-item.active { color: var(--primary); transform: translateY(-2px); }
    .nav-item .material-icons { font-size: 26px; }
    .nav-item span:not(.material-icons) { font-size: 9px; font-weight: 800; letter-spacing: 0.05em; }

    .btn-add-center {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      width: 56px; height: 56px;
      border-radius: 1.25rem;
      display: flex; align-items: center; justify-content: center;
      margin-top: -45px;
      box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
      border: 4px solid var(--bg);
      transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .btn-add-center:active { transform: scale(0.85); }

    .modal { display: none; position: fixed; z-index: 200; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); align-items: flex-end; justify-content: center; }
    .modal.active { display: flex; }
    
    .modal-content {
      background: white;
      width: 100%;
      max-width: 500px;
      border-radius: 2.5rem 2.5rem 0 0;
      padding-bottom: env(safe-area-inset-bottom);
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .kk-card { border-left: 5px solid var(--primary); transition: all 0.3s ease; }
    .kk-card.open { border-left-width: 8px; }
    .kk-members { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
    .kk-card.open .kk-members { max-height: 1000px; margin-top: 1rem; }

    .chip-filter { transition: all 0.3s ease; scroll-snap-align: start; }
    .chip-filter.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }
    
    .scroll-hide::-webkit-scrollbar { display: none; }
    .scroll-hide { -ms-overflow-style: none; scrollbar-width: none; scroll-snap-type: x mandatory; }

    .stat-card { background: linear-gradient(135deg, #ffffff, #f1f5f9); position: relative; overflow: hidden; }
    .stat-card::before { content: ''; position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; border-radius: 50%; opacity: 0.1; background: currentColor; }

    .glass-header { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
  </style>
</head>
<body>

  <!-- LOGIN PAGE -->
  <div id="login-page" class="fixed inset-0 bg-white z-[300] flex items-center justify-center p-8">
    <div class="w-full max-w-sm text-center">
      <div class="bg-gradient-to-br from-indigo-600 to-blue-500 text-white w-24 h-24 rounded-[2.5rem] flex items-center justify-center mx-auto mb-8 shadow-2xl rotate-3">
        <span class="material-icons text-5xl">location_city</span>
      </div>
      <h2 class="text-4xl font-black text-slate-800 tracking-tighter mb-2">E-Warga</h2>
      <p class="text-slate-400 mb-12 font-medium">Manajemen Lingkungan Modern</p>
      <form id="login-form" class="space-y-4">
        <div class="relative">
            <span class="material-icons absolute left-5 top-4 text-slate-300">person</span>
            <input type="text" id="username" placeholder="Username" class="w-full pl-14 pr-6 py-4 rounded-2xl bg-slate-50 border border-slate-100 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" required>
        </div>
        <div class="relative">
            <span class="material-icons absolute left-5 top-4 text-slate-300">lock</span>
            <input type="password" id="password" placeholder="Password" class="w-full pl-14 pr-6 py-4 rounded-2xl bg-slate-50 border border-slate-100 focus:ring-2 focus:ring-indigo-500 outline-none transition-all" required>
        </div>
        <button type="submit" class="w-full bg-indigo-600 text-white font-extrabold py-5 rounded-2xl shadow-xl shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition-all mt-6">MASUK SEKARANG</button>
      </form>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="main-app" class="hidden min-h-screen flex flex-col">
    <header class="glass-header border-b border-slate-100 px-6 py-4 sticky top-0 z-40 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-tr from-indigo-600 to-blue-500 rounded-xl flex items-center justify-center text-white shadow-lg"><span class="material-icons text-xl">home</span></div>
        <div>
            <span class="font-extrabold text-slate-800 tracking-tight text-lg block leading-none">E-Warga</span>
            <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Dashboard</span>
        </div>
      </div>
      <button onclick="logout()" class="w-10 h-10 rounded-full bg-slate-50 text-slate-400 flex items-center justify-center active:bg-red-50 active:text-red-500 transition-colors">
        <span class="material-icons text-xl">power_settings_new</span>
      </button>
    </header>

    <main class="flex-1 max-w-md mx-auto w-full p-5 pb-32">
      <!-- DASHBOARD -->
      <section id="page-dashboard" class="page active space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div class="stat-card p-5 rounded-[2rem] shadow-sm border border-slate-100 text-indigo-600">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Warga</p>
            <h3 id="stat-total" class="text-3xl font-black">0</h3>
            <div class="mt-2 text-[9px] font-bold text-slate-400 flex items-center gap-1"><span class="material-icons text-[12px] text-green-500">trending_up</span> Terdata Aktif</div>
          </div>
          <div class="stat-card p-5 rounded-[2rem] shadow-sm border border-slate-100 text-blue-500">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total KK</p>
            <h3 id="stat-kk" class="text-3xl font-black">0</h3>
            <div class="mt-2 text-[9px] font-bold text-slate-400 flex items-center gap-1"><span class="material-icons text-[12px]">groups</span> Kepala Keluarga</div>
          </div>
        </div>

        <div class="flex gap-3">
            <div class="flex-1 bg-gradient-to-br from-indigo-50 to-white p-4 rounded-3xl border border-indigo-100 flex items-center gap-3">
                <div class="w-10 h-10 bg-indigo-600 text-white rounded-2xl flex items-center justify-center shadow-md"><span class="material-icons">male</span></div>
                <div><p class="text-[9px] font-bold text-slate-400 uppercase">Pria</p><p id="stat-l" class="font-black text-indigo-600">0</p></div>
            </div>
            <div class="flex-1 bg-gradient-to-br from-rose-50 to-white p-4 rounded-3xl border border-rose-100 flex items-center gap-3">
                <div class="w-10 h-10 bg-rose-500 text-white rounded-2xl flex items-center justify-center shadow-md"><span class="material-icons">female</span></div>
                <div><p class="text-[9px] font-bold text-slate-400 uppercase">Wanita</p><p id="stat-p" class="font-black text-rose-500">0</p></div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-50 h-72">
            <div class="flex justify-between items-center mb-4">
                <h4 class="text-xs font-black uppercase text-slate-400 tracking-widest">Distribusi RT</h4>
                <span class="material-icons text-slate-300">bar_chart</span>
            </div>
           <canvas id="chartRT"></canvas>
        </div>

        <div class="flex justify-between items-center px-2">
          <h3 class="font-black text-slate-800 flex items-center gap-2"><span class="material-icons text-indigo-500">auto_awesome</span> Warga Baru</h3>
          <button onclick="navigate('warga')" class="text-xs font-bold text-indigo-600">Lihat Semua</button>
        </div>
        <div id="recent-list" class="space-y-3"></div>
      </section>

      <!-- DATA WARGA -->
      <section id="page-warga" class="page space-y-4">
        <div class="relative group">
          <input type="text" id="search" oninput="doSearch()" placeholder="Cari Nama atau NIK..." class="w-full pl-14 pr-4 py-5 bg-white rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/40 outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
          <span class="material-icons absolute left-5 top-5 text-slate-300 group-focus-within:text-indigo-500">search</span>
        </div>
        
        <!-- Optimized RT Filter Chips -->
        <div class="flex gap-3 overflow-x-auto pb-4 pt-1 px-1 scroll-hide">
            <button onclick="filterRT('all')" class="chip-filter active whitespace-nowrap px-6 py-3 rounded-2xl bg-white border border-slate-100 text-[11px] font-black tracking-widest" id="chip-all">SEMUA</button>
            <button onclick="filterRT('1')" class="chip-filter whitespace-nowrap px-6 py-3 rounded-2xl bg-white border border-slate-100 text-[11px] font-black tracking-widest flex items-center gap-2" id="chip-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> RT 01</button>
            <button onclick="filterRT('2')" class="chip-filter whitespace-nowrap px-6 py-3 rounded-2xl bg-white border border-slate-100 text-[11px] font-black tracking-widest flex items-center gap-2" id="chip-2"><span class="w-2 h-2 rounded-full bg-indigo-500"></span> RT 02</button>
            <button onclick="filterRT('3')" class="chip-filter whitespace-nowrap px-6 py-3 rounded-2xl bg-white border border-slate-100 text-[11px] font-black tracking-widest flex items-center gap-2" id="chip-3"><span class="w-2 h-2 rounded-full bg-purple-500"></span> RT 03</button>
            <button onclick="filterRT('4')" class="chip-filter whitespace-nowrap px-6 py-3 rounded-2xl bg-white border border-slate-100 text-[11px] font-black tracking-widest flex items-center gap-2" id="chip-4"><span class="w-2 h-2 rounded-full bg-rose-500"></span> RT 04</button>
        </div>

        <div id="warga-list" class="grid grid-cols-1 gap-3"></div>
      </section>

      <!-- DATA KK -->
      <section id="page-kk" class="page space-y-4">
        <div class="relative">
          <input type="text" id="search-kk" oninput="doSearchKK()" placeholder="Cari Kepala Keluarga..." class="w-full pl-14 pr-4 py-5 bg-white rounded-[2rem] border border-slate-100 shadow-xl shadow-slate-200/40 outline-none">
          <span class="material-icons absolute left-5 top-5 text-slate-300">groups</span>
        </div>
        <div id="kk-list" class="space-y-4"></div>
      </section>
    </main>

    <!-- NAVIGATION BAR -->
    <nav class="bottom-nav">
      <button onclick="navigate('dashboard')" id="nav-dashboard" class="nav-item active">
        <span class="material-icons">grid_view</span><span>BERANDA</span>
      </button>
      <button onclick="navigate('warga')" id="nav-warga" class="nav-item">
        <span class="material-icons">person</span><span>WARGA</span>
      </button>
      <button onclick="openForm()" class="btn-add-center">
        <span class="material-icons text-3xl">add</span>
      </button>
      <button onclick="navigate('kk')" id="nav-kk" class="nav-item">
        <span class="material-icons">diversity_3</span><span>KELUARGA</span>
      </button>
      <button onclick="refreshData()" class="nav-item">
        <span class="material-icons">sync</span><span>UPDATE</span>
      </button>
    </nav>
  </div>

  <!-- FORM MODAL -->
  <div id="modal-form" class="modal" onclick="if(event.target == this) closeModal('form')">
    <div class="modal-content overflow-hidden flex flex-col">
      <div class="p-8 border-b flex justify-between items-center bg-indigo-600 text-white">
        <div>
            <h3 id="form-title" class="font-black text-xl tracking-tight">Input Data Warga</h3>
            <p class="text-[10px] text-indigo-200 font-bold uppercase tracking-widest">Lengkapi formulir di bawah</p>
        </div>
        <button onclick="closeModal('form')" class="w-10 h-10 bg-white/10 rounded-full flex items-center justify-center hover:bg-white/20 transition-colors"><span class="material-icons">close</span></button>
      </div>
      <form id="entry-form" class="p-6 space-y-8 overflow-y-auto flex-1 max-h-[75vh]">
        <input type="hidden" id="f-original-nik">
        
        <!-- Identitas Utama -->
        <div class="space-y-4">
          <div class="flex items-center gap-2 mb-2">
              <span class="w-8 h-8 rounded-lg bg-indigo-50 text-indigo-600 flex items-center justify-center"><span class="material-icons text-sm">badge</span></span>
              <p class="text-xs font-black text-slate-800 uppercase tracking-widest">Identitas Dasar</p>
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">NIK</label><input type="text" id="f-nik" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20" required></div>
            <div class="col-span-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">No KK</label><input type="text" id="f-kk" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20" required></div>
            <div class="col-span-2"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Nama Lengkap</label><input type="text" id="f-nama" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500/20" required></div>
            <div class="col-span-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Kelamin</label><select id="f-kelamin" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none"><option>Laki-Laki</option><option>Perempuan</option></select></div>
            <div class="col-span-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Agama</label><select id="f-agama" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none"><option>Islam</option><option>Kristen</option><option>Katolik</option><option>Buddha</option><option>Hindu</option><option>Konghucu</option></select></div>
          </div>
        </div>

        <!-- Kelahiran & Status -->
        <div class="space-y-4">
            <div class="flex items-center gap-2 mb-2">
                <span class="w-8 h-8 rounded-lg bg-amber-50 text-amber-600 flex items-center justify-center"><span class="material-icons text-sm">event</span></span>
                <p class="text-xs font-black text-slate-800 uppercase tracking-widest">Kelahiran & Status</p>
            </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Tempat Lahir</label><input type="text" id="f-tempat-lahir" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none"></div>
            <div class="col-span-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Tanggal Lahir</label><input type="date" id="f-tgl-lahir" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none"></div>
            <div class="col-span-2"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Status Perkawinan</label><select id="f-perkawinan" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none"><option>Belum kawin</option><option>Kawin</option><option>Cerai Hidup</option><option>Cerai Mati</option></select></div>
          </div>
        </div>

        <!-- Alamat -->
        <div class="space-y-4">
          <div class="flex justify-between items-center mb-2">
            <div class="flex items-center gap-2">
                <span class="w-8 h-8 rounded-lg bg-rose-50 text-rose-600 flex items-center justify-center"><span class="material-icons text-sm">location_on</span></span>
                <p class="text-xs font-black text-slate-800 uppercase tracking-widest">Alamat</p>
            </div>
            <label class="flex items-center gap-2 cursor-pointer bg-slate-50 px-3 py-1 rounded-full border border-slate-100">
                <input type="checkbox" id="sync-ktp" onchange="syncAlamatKTP()" class="w-3 h-3 rounded text-indigo-600">
                <span class="text-[9px] font-black text-slate-500 uppercase">Sama KTP</span>
            </label>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div class="col-span-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Blok</label><select id="f-blok" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none"><option>A</option><option>B</option><option>B1</option><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option></select></div>
            <div class="col-span-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">No</label><input type="text" id="f-nomer" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none"></div>
            <div class="col-span-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">RT</label><select id="f-rt" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none"><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
            <div class="col-span-3"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Alamat KTP Lengkap</label><textarea id="f-ktp-alamat" rows="2" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none" placeholder="Isi sesuai kartu identitas..."></textarea></div>
          </div>
        </div>

        <!-- Pekerjaan & Keluarga -->
        <div class="space-y-4">
            <div class="flex items-center gap-2 mb-2">
                <span class="w-8 h-8 rounded-lg bg-emerald-50 text-emerald-600 flex items-center justify-center"><span class="material-icons text-sm">work</span></span>
                <p class="text-xs font-black text-slate-800 uppercase tracking-widest">Profesi & Status</p>
            </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2">
                <label class="text-[10px] font-black text-slate-400 uppercase ml-1">Pekerjaan</label>
                <select id="f-pekerjaan" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none">
                    <option>Belum/Tidak Bekerja</option><option>Mengurus Rumah Tangga</option><option>Pelajar/Mahasiswa</option><option>Pensiunan</option><option>PNS</option><option>TNI</option><option>POLRI</option><option>Karyawan Swasta</option><option>Wiraswasta</option><option>Petani</option><option>Nelayan</option><option>Lainnya</option>
                </select>
            </div>
            <div class="col-span-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">No HP (WA)</label><input type="text" id="f-hp" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none" placeholder="08xx..."></div>
            <div class="col-span-1"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Status Keluarga</label><select id="f-status-kel" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none"><option>Kepala Keluarga</option><option>Istri</option><option>Anak</option><option>Orang Tua</option><option>Lainnya</option></select></div>
            <div class="col-span-2"><label class="text-[10px] font-black text-slate-400 uppercase ml-1">Status Tinggal</label><select id="f-tinggal" class="w-full bg-slate-50 p-4 rounded-2xl border border-slate-100 outline-none"><option>Tetap</option><option>Kontrak</option><option>Kos</option><option>Lainnya</option></select></div>
          </div>
        </div>

        <button type="submit" class="w-full bg-indigo-600 text-white font-black py-5 rounded-2xl shadow-xl shadow-indigo-100 mt-6 mb-4 sticky bottom-0 active:scale-95 transition-transform">SIMPAN DATA WARGA</button>
      </form>
    </div>
  </div>

  <!-- DETAIL MODAL (Optimized for Mobile) -->
  <div id="modal-detail" class="modal" onclick="if(event.target == this) closeModal('detail')">
    <div class="modal-content overflow-hidden max-h-[95vh] flex flex-col">
        <div id="detail-header" class="p-10 bg-gradient-to-br from-indigo-700 to-indigo-500 text-white relative flex flex-col items-center text-center">
            <button onclick="closeModal('detail')" class="absolute top-6 right-6 w-8 h-8 bg-black/10 rounded-full flex items-center justify-center"><span class="material-icons text-lg">close</span></button>
            <div class="w-24 h-24 bg-white/20 rounded-[2.5rem] flex items-center justify-center mb-5 border-4 border-white/10 shadow-inner backdrop-blur-md">
                <span class="material-icons text-6xl text-white">account_circle</span>
            </div>
            <h2 id="d-nama" class="text-2xl font-black mb-2 tracking-tight">Nama Warga</h2>
            <div class="px-5 py-1.5 bg-white text-indigo-600 rounded-full text-[10px] font-black uppercase tracking-widest shadow-lg" id="d-status-tag">STATUS</div>
        </div>
        
        <div class="p-6 overflow-y-auto flex-1 bg-white">
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">NIK</p>
                    <p id="d-nik" class="text-sm font-extrabold text-slate-800">0</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">No KK</p>
                    <p id="d-kk" class="text-sm font-extrabold text-slate-800">0</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Blok/No - RT</p>
                    <p id="d-alamat" class="text-sm font-extrabold text-indigo-600">-</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Pekerjaan</p>
                    <p id="d-kerja" class="text-sm font-extrabold text-slate-800">-</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Lahir</p>
                    <p id="d-lahir" class="text-sm font-extrabold text-slate-800">-</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Agama</p>
                    <p id="d-agama" class="text-sm font-extrabold text-slate-800">-</p>
                </div>
                <div class="col-span-2 detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Alamat KTP</p>
                    <p id="d-ktp" class="text-[11px] font-medium text-slate-500 leading-relaxed italic">-</p>
                </div>
            </div>

            <div class="flex gap-4 mb-6">
                <button id="btn-edit" class="flex-1 bg-slate-100 text-slate-600 font-black py-5 rounded-2xl flex items-center justify-center gap-2 active:bg-slate-200 transition-colors"><span class="material-icons text-xl">edit</span> Edit</button>
                <button id="btn-wa" class="flex-2 bg-emerald-500 text-white font-black py-5 rounded-2xl flex items-center justify-center gap-2 shadow-xl shadow-emerald-100 active:scale-95 transition-all"><span class="material-icons">chat</span> WhatsApp</button>
            </div>
        </div>
    </div>
  </div>

  <!-- LOADING -->
  <div id="loading" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[400] hidden flex items-center justify-center p-6">
    <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl flex flex-col items-center max-w-xs w-full">
        <div class="w-16 h-16 relative mb-6">
            <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-t-indigo-600 rounded-full animate-spin"></div>
        </div>
        <p class="text-sm font-black text-slate-800 uppercase tracking-widest text-center">Menghubungkan Server...</p>
        <p class="text-[10px] text-slate-400 font-bold mt-2 text-center uppercase">Harap Tunggu Sebentar</p>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyQnIfaRQhv6r9jL_bJ3-uX9RhyUSAnUF4kt_lTCpgkHjWtXsCk4OWTBLPxB3JDz6L0qw/exec";
    let ALL_DATA = [];
    let CURRENT_FILTER_RT = 'all';
    let rtChart;

    const getVal = (obj, pattern) => {
      const keys = Object.keys(obj);
      const match = keys.find(k => k.toLowerCase().replace(/[^a-z]/g, '').includes(pattern.toLowerCase().replace(/[^a-z]/g, '')));
      return match ? obj[match] : "";
    };

    const clean = (v) => (v === undefined || v === null || v === "") ? "-" : String(v).trim();

    function syncAlamatKTP() {
        const isChecked = document.getElementById('sync-ktp').checked;
        if(isChecked) {
            const blok = document.getElementById('f-blok').value;
            const nomer = document.getElementById('f-nomer').value;
            const rt = document.getElementById('f-rt').value;
            document.getElementById('f-ktp-alamat').value = `Blok ${blok} No. ${nomer} RT 0${rt}`;
        }
    }

    async function callAPI(action, args = []) {
      const isPost = action === 'saveWarga';
      const options = {
        method: isPost ? 'POST' : 'GET',
        mode: 'cors',
        headers: isPost ? { 'Content-Type': 'text/plain;charset=utf-8' } : {}
      };
      let url = API_URL;
      if (isPost) options.body = JSON.stringify({ action, args });
      else url += `?action=${action}&args=${encodeURIComponent(JSON.stringify(args))}`;
      
      try {
        const response = await fetch(url, options);
        return await response.json();
      } catch (e) {
        return { success: false, error: "Koneksi Bermasalah" };
      }
    }

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      toggleLoading(true);
      const res = await callAPI('checkLogin', [document.getElementById('username').value, document.getElementById('password').value]);
      if(res && res.success) {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('main-app').classList.remove('hidden');
        await refreshData();
      } else alert("Akses Ditolak!");
      toggleLoading(false);
    });

    async function refreshData() {
      toggleLoading(true);
      const data = await callAPI('getAllWarga');
      if (Array.isArray(data)) {
        ALL_DATA = data;
        updateUI();
      }
      toggleLoading(false);
    }

    function updateUI() {
      const listKK = ALL_DATA.filter(w => {
          const status = clean(getVal(w, "Status Keluarga")).toLowerCase();
          return status.includes("kepala");
      });
      
      document.getElementById('stat-total').innerText = ALL_DATA.length;
      document.getElementById('stat-kk').innerText = listKK.length;
      
      let l = 0, p = 0;
      const rtStats = { "1":0, "2":0, "3":0, "4":0 };
      
      ALL_DATA.forEach(w => {
        const kel = clean(getVal(w, "Kelamin")).toLowerCase();
        if(kel.startsWith('l')) l++; else if(kel.startsWith('p')) p++;
        const rt = clean(getVal(w, "RT"));
        if(rtStats[rt] !== undefined) rtStats[rt]++;
      });

      document.getElementById('stat-l').innerText = l;
      document.getElementById('stat-p').innerText = p;

      renderChart(rtStats);
      renderRecent(ALL_DATA.slice(-5).reverse());
      renderKK(listKK);
      doSearch();
    }

    function renderRecent(list) {
        document.getElementById('recent-list').innerHTML = list.map(w => `
            <div onclick="viewDetail('${getVal(w, "NIK")}')" class="bg-white p-5 rounded-3xl border border-slate-50 flex items-center gap-4 active:scale-[0.98] transition-all shadow-sm">
                <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-2xl flex items-center justify-center font-black text-xs shadow-inner">${clean(getVal(w, "Blok"))}</div>
                <div class="flex-1 min-w-0">
                    <p class="font-extrabold text-slate-800 text-sm truncate">${getVal(w, "Nama")}</p>
                    <p class="text-[10px] text-slate-400 uppercase font-black tracking-wider">${clean(getVal(w, "Blok"))}/${clean(getVal(w, "Nomer"))} • RT ${clean(getVal(w, "RT"))}</p>
                </div>
                <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center"><span class="material-icons text-slate-300 text-sm">chevron_right</span></div>
            </div>
        `).join('');
    }

    function renderKK(list) {
      if(list.length === 0) {
          document.getElementById('kk-list').innerHTML = `<div class="p-10 text-center text-slate-400 text-xs font-bold uppercase tracking-widest">Data Keluarga Kosong</div>`;
          return;
      }
      document.getElementById('kk-list').innerHTML = list.map(k => {
        const noKK = clean(getVal(k, "KK"));
        const members = ALL_DATA.filter(w => clean(getVal(w, "KK")) === noKK);
        return `
          <div class="kk-card bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm overflow-hidden">
            <div class="flex items-center gap-4 cursor-pointer" onclick="this.parentElement.classList.toggle('open')">
              <div class="bg-gradient-to-tr from-indigo-600 to-indigo-400 text-white w-12 h-12 rounded-2xl flex items-center justify-center font-black text-xs shadow-lg shadow-indigo-100">${clean(getVal(k, "Blok"))}</div>
              <div class="flex-1 min-w-0">
                <p class="font-extrabold text-slate-800 text-sm truncate uppercase tracking-tight">${getVal(k, "Nama")}</p>
                <p class="text-[10px] text-slate-400 mt-1 font-bold">KK: ${noKK}</p>
              </div>
              <span class="material-icons text-slate-300 transform transition-transform">expand_more</span>
            </div>
            <div class="kk-members"><div class="space-y-2 mt-4 pt-4 border-t border-slate-50">
              ${members.map(m => `<div onclick="viewDetail('${getVal(m, "NIK")}')" class="bg-slate-50/50 p-4 rounded-2xl text-xs font-extrabold text-slate-600 flex justify-between items-center active:bg-indigo-50 active:text-indigo-600 transition-all border border-transparent active:border-indigo-100">
                <span class="truncate pr-4">${getVal(m, "Nama")}</span><span class="text-[8px] px-2 py-0.5 bg-white border border-slate-100 rounded-full text-slate-400 font-black uppercase tracking-tighter shrink-0">${clean(getVal(m, "Status Keluarga"))}</span>
              </div>`).join('')}
            </div></div>
          </div>
        `;
      }).join('');
    }

    function filterRT(rt) {
        CURRENT_FILTER_RT = rt;
        document.querySelectorAll('.chip-filter').forEach(c => c.classList.remove('active'));
        document.getElementById('chip-'+rt).classList.add('active');
        doSearch();
        
        // Auto scroll filter chip into view
        document.getElementById('chip-'+rt).scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }

    function doSearch() {
      const q = document.getElementById('search').value.toLowerCase();
      const filtered = ALL_DATA.filter(w => {
          const matchSearch = getVal(w, "Nama").toLowerCase().includes(q) || getVal(w, "NIK").toString().includes(q);
          const matchRT = CURRENT_FILTER_RT === 'all' || clean(getVal(w, "RT")) === CURRENT_FILTER_RT;
          return matchSearch && matchRT;
      });
      document.getElementById('warga-list').innerHTML = filtered.map(w => `
        <div onclick="viewDetail('${getVal(w, "NIK")}')" class="bg-white p-5 rounded-[2rem] border border-slate-50 flex items-center gap-4 active:scale-[0.97] transition-all shadow-sm">
          <div class="w-14 h-14 bg-gradient-to-br from-slate-100 to-slate-50 rounded-2xl flex items-center justify-center font-black text-slate-400 text-sm shadow-inner">${clean(getVal(w, "Blok"))}</div>
          <div class="flex-1 min-w-0">
            <p class="font-extrabold text-slate-800 text-sm truncate uppercase tracking-tight">${getVal(w, "Nama")}</p>
            <p class="text-[10px] text-slate-400 font-bold mt-1">NIK ${getVal(w, "NIK")}</p>
          </div>
          <div class="text-right shrink-0">
            <div class="inline-block px-3 py-1 bg-indigo-50 text-indigo-600 rounded-full text-[9px] font-black tracking-widest uppercase">RT ${clean(getVal(w, "RT"))}</div>
          </div>
        </div>
      `).join('');
    }

    function doSearchKK() {
        const q = document.getElementById('search-kk').value.toLowerCase();
        const listKK = ALL_DATA.filter(w => {
            const status = clean(getVal(w, "Status Keluarga")).toLowerCase();
            const nama = getVal(w, "Nama").toLowerCase();
            return status.includes("kepala") && nama.includes(q);
        });
        renderKK(listKK);
    }

    function viewDetail(nik) {
        const w = ALL_DATA.find(x => String(getVal(x, "NIK")) === String(nik));
        if(!w) return;
        
        document.getElementById('d-nama').innerText = getVal(w, "Nama");
        document.getElementById('d-nik').innerText = getVal(w, "NIK");
        document.getElementById('d-kk').innerText = getVal(w, "KK");
        document.getElementById('d-alamat').innerText = `${clean(getVal(w, "Blok"))}/${clean(getVal(w, "Nomer"))} • RT 0${clean(getVal(w, "RT"))}`;
        document.getElementById('d-status-tag').innerText = clean(getVal(w, "Status Keluarga"));
        document.getElementById('d-lahir').innerText = `${clean(getVal(w, "Tempat Lahir"))}, ${clean(getVal(w, "Tanggal Lahir"))}`;
        document.getElementById('d-agama').innerText = clean(getVal(w, "Agama"));
        document.getElementById('d-kerja').innerText = clean(getVal(w, "Pekerjaan"));
        document.getElementById('d-ktp').innerText = clean(getVal(w, "Alamat KTP"));
        
        document.getElementById('btn-wa').onclick = () => {
            const hp = clean(getVal(w, "HP"));
            if(hp !== "-" && hp.length > 5) window.open(`https://wa.me/${hp.replace(/^0/, '62')}`, '_blank');
            else alert("Nomor HP tidak valid");
        };

        document.getElementById('btn-edit').onclick = () => {
            closeModal('detail');
            openForm(w);
        };
        
        document.getElementById('modal-detail').classList.add('active');
    }

    function openForm(editData = null) {
      const f = document.getElementById('entry-form');
      f.reset();
      document.getElementById('f-original-nik').value = "";
      document.getElementById('form-title').innerText = "Input Data Warga";
      document.getElementById('sync-ktp').checked = false;
      
      if(editData) {
        document.getElementById('form-title').innerText = "Edit Data Warga";
        document.getElementById('f-original-nik').value = getVal(editData, "NIK");
        document.getElementById('f-nik').value = getVal(editData, "NIK");
        document.getElementById('f-kk').value = getVal(editData, "KK");
        document.getElementById('f-nama').value = getVal(editData, "Nama");
        document.getElementById('f-kelamin').value = getVal(editData, "Kelamin");
        document.getElementById('f-agama').value = getVal(editData, "Agama");
        document.getElementById('f-tempat-lahir').value = getVal(editData, "Tempat Lahir");
        document.getElementById('f-tgl-lahir').value = getVal(editData, "Tanggal Lahir");
        document.getElementById('f-perkawinan').value = getVal(editData, "Status Perkawinan");
        document.getElementById('f-blok').value = getVal(editData, "Blok");
        document.getElementById('f-nomer').value = getVal(editData, "Nomer");
        document.getElementById('f-rt').value = getVal(editData, "RT");
        document.getElementById('f-ktp-alamat').value = getVal(editData, "Alamat KTP");
        document.getElementById('f-pekerjaan').value = getVal(editData, "Pekerjaan");
        document.getElementById('f-hp').value = getVal(editData, "HP");
        document.getElementById('f-tinggal').value = getVal(editData, "Status Tinggal");
        document.getElementById('f-status-kel').value = getVal(editData, "Status Keluarga");
      }
      document.getElementById('modal-form').classList.add('active');
    }

    document.getElementById('entry-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        toggleLoading(true);
        const blok = document.getElementById('f-blok').value;
        const nomer = document.getElementById('f-nomer').value;
        const data = {
            nik: document.getElementById('f-nik').value,
            kk: document.getElementById('f-kk').value,
            nama: document.getElementById('f-nama').value,
            kelamin: document.getElementById('f-kelamin').value,
            agama: document.getElementById('f-agama').value,
            tempat: document.getElementById('f-tempat-lahir').value,
            tanggal: document.getElementById('f-tgl-lahir').value,
            perkawinan: document.getElementById('f-perkawinan').value,
            blok: blok, nomer: nomer, rt: document.getElementById('f-rt').value,
            alamatKTP: document.getElementById('f-ktp-alamat').value,
            alamatTinggal: `Blok ${blok} No ${nomer}`,
            pekerjaan: document.getElementById('f-pekerjaan').value,
            hp: document.getElementById('f-hp').value,
            tinggal: document.getElementById('f-tinggal').value,
            statusKel: document.getElementById('f-status-kel').value,
            originalNik: document.getElementById('f-original-nik').value
        };
        const res = await callAPI('saveWarga', [data]);
        if(res.success) { closeModal('form'); await refreshData(); }
        else alert("Gagal: " + res.error);
        toggleLoading(false);
    });

    function navigate(p) {
      document.querySelectorAll('.page').forEach(e => e.classList.toggle('active', e.id === 'page-'+p));
      document.querySelectorAll('.nav-item').forEach(e => e.classList.toggle('active', e.id === 'nav-'+p));
    }
    function logout() { location.reload(); }
    function closeModal(id) { document.getElementById('modal-'+id).classList.remove('active'); }
    function toggleLoading(s) { document.getElementById('loading').classList.toggle('hidden', !s); }

    function renderChart(rtData) {
      const ctx = document.getElementById('chartRT').getContext('2d');
      if(rtChart) rtChart.destroy();
      rtChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: ['RT 01', 'RT 02', 'RT 03', 'RT 04'], datasets: [{ label: 'Warga', data: [rtData["1"], rtData["2"], rtData["3"], rtData["4"]], backgroundColor: ['#3b82f6', '#4f46e5', '#a855f7', '#f43f5e'], borderRadius: 12 }] },
        options: { 
            responsive: true, maintainAspectRatio: false, 
            plugins: { legend: { display: false } }, 
            scales: { 
                y: { display: false, beginAtZero: true },
                x: { grid: { display: false }, border: { display: false }, ticks: { font: { size: 11, weight: '900' }, color: '#94a3b8' } }
            } 
        }
      });
    }
  </script>
</body>
</html>
