<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Warga - Manajemen Data Terintegrasi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
    body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; margin: 0; padding: 0; }
    .page { display: none; }
    .page.active { display: block; animation: fadeIn 0.4s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    
    .bottom-nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 0.75rem 0.5rem calc(0.75rem + env(safe-area-inset-bottom));
      border-top: 1px solid #f1f5f9;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
      z-index: 100;
    }
    
    .nav-item { color: #94a3b8; transition: all 0.3s ease; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 2px; border: none; background: none; cursor: pointer; }
    .nav-item.active { color: #2563eb; }
    .nav-item .material-icons { font-size: 24px; }
    .nav-item span:not(.material-icons) { font-size: 10px; font-weight: 700; }

    .btn-add-center {
      background: #2563eb;
      color: white;
      width: 52px; height: 52px;
      border-radius: 18px;
      display: flex; align-items: center; justify-content: center;
      margin-top: -30px;
      box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
      border: 4px solid white;
      transition: all 0.3s ease;
    }
    .btn-add-center:active { transform: scale(0.9); }

    .modal { display: none; position: fixed; z-index: 200; inset: 0; background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(8px); align-items: center; justify-content: center; padding: 1rem; }
    .modal.active { display: flex; }
    
    .kk-card.open .kk-members { max-height: 1500px; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f1f5f9; }
    .kk-members { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; }
    
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    .chip-filter.active { background-color: #2563eb; color: white; border-color: #2563eb; }
    
    .detail-grid-item { background: #f8fafc; padding: 12px; border-radius: 16px; border: 1px solid #f1f5f9; }
  </style>
</head>
<body class="text-slate-900">

  <!-- LOGIN PAGE -->
  <div id="login-page" class="fixed inset-0 bg-white z-[300] flex items-center justify-center p-6">
    <div class="w-full max-w-sm text-center">
      <div class="bg-blue-600 text-white w-20 h-20 rounded-[2rem] flex items-center justify-center mx-auto mb-6 shadow-xl">
        <span class="material-icons text-4xl">location_city</span>
      </div>
      <h2 class="text-3xl font-extrabold text-slate-800 tracking-tight">E-Warga</h2>
      <p class="text-slate-500 mb-10 font-medium">Manajemen Data Blok</p>
      <form id="login-form" class="space-y-4">
        <input type="text" id="username" placeholder="Username" class="w-full px-6 py-4 rounded-2xl bg-slate-50 border border-slate-100 focus:ring-2 focus:ring-blue-500 outline-none transition-all" required>
        <input type="password" id="password" placeholder="Password" class="w-full px-6 py-4 rounded-2xl bg-slate-50 border border-slate-100 focus:ring-2 focus:ring-blue-500 outline-none transition-all" required>
        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-blue-700 transition-all mt-4">Login</button>
      </form>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="main-app" class="hidden min-h-screen flex flex-col">
    <header class="bg-white/80 backdrop-blur-md border-b px-6 py-4 sticky top-0 z-40 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white"><span class="material-icons text-sm">home</span></div>
        <span class="font-bold text-slate-800 tracking-tight text-lg">E-Warga</span>
      </div>
      <button onclick="logout()" class="text-slate-400 hover:text-red-500"><span class="material-icons">logout</span></button>
    </header>

    <main class="flex-1 max-w-3xl mx-auto w-full p-5 pb-24">
      <!-- DASHBOARD -->
      <section id="page-dashboard" class="page active space-y-6">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total Warga</p>
            <h3 id="stat-total" class="text-3xl font-extrabold">0</h3>
          </div>
          <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100">
            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total KK</p>
            <h3 id="stat-kk" class="text-3xl font-extrabold text-blue-600">0</h3>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-3xl border border-slate-100 flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center"><span class="material-icons">male</span></div>
                <div><p class="text-[10px] font-bold text-slate-400 uppercase">Laki-Laki</p><p id="stat-l" class="font-bold">0</p></div>
            </div>
            <div class="bg-white p-4 rounded-3xl border border-slate-100 flex items-center gap-3">
                <div class="w-10 h-10 bg-pink-50 text-pink-600 rounded-full flex items-center justify-center"><span class="material-icons">female</span></div>
                <div><p class="text-[10px] font-bold text-slate-400 uppercase">Perempuan</p><p id="stat-p" class="font-bold">0</p></div>
            </div>
        </div>

        <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100 h-64">
           <canvas id="chartRT"></canvas>
        </div>

        <div class="flex justify-between items-center">
          <h3 class="font-bold text-slate-800 flex items-center gap-2"><span class="material-icons text-blue-500">history</span> Warga Baru</h3>
        </div>
        <div id="recent-list" class="space-y-3"></div>
      </section>

      <!-- DATA WARGA -->
      <section id="page-warga" class="page space-y-4">
        <div class="relative">
          <input type="text" id="search" oninput="doSearch()" placeholder="Cari Nama atau NIK..." class="w-full pl-12 pr-4 py-4 bg-white rounded-2xl border border-slate-100 shadow-sm outline-none">
          <span class="material-icons absolute left-4 top-4 text-slate-300">search</span>
        </div>
        
        <div class="flex gap-2 overflow-x-auto pb-2 scroll-hide">
            <button onclick="filterRT('all')" class="chip-filter active whitespace-nowrap px-4 py-2 rounded-full bg-white border border-slate-100 text-xs font-bold" id="chip-all">SEMUA</button>
            <button onclick="filterRT('1')" class="chip-filter whitespace-nowrap px-4 py-2 rounded-full bg-white border border-slate-100 text-xs font-bold" id="chip-1">RT 01</button>
            <button onclick="filterRT('2')" class="chip-filter whitespace-nowrap px-4 py-2 rounded-full bg-white border border-slate-100 text-xs font-bold" id="chip-2">RT 02</button>
            <button onclick="filterRT('3')" class="chip-filter whitespace-nowrap px-4 py-2 rounded-full bg-white border border-slate-100 text-xs font-bold" id="chip-3">RT 03</button>
            <button onclick="filterRT('4')" class="chip-filter whitespace-nowrap px-4 py-2 rounded-full bg-white border border-slate-100 text-xs font-bold" id="chip-4">RT 04</button>
        </div>

        <div id="warga-list" class="grid grid-cols-1 gap-3"></div>
      </section>

      <!-- DATA KK -->
      <section id="page-kk" class="page space-y-4">
        <div class="relative">
          <input type="text" id="search-kk" oninput="doSearchKK()" placeholder="Cari Kepala Keluarga..." class="w-full pl-12 pr-4 py-4 bg-white rounded-2xl border border-slate-100 shadow-sm outline-none">
          <span class="material-icons absolute left-4 top-4 text-slate-300">search</span>
        </div>
        <div id="kk-list" class="space-y-4"></div>
      </section>
    </main>

    <!-- NAVIGATION BAR -->
    <nav class="bottom-nav">
      <button onclick="navigate('dashboard')" id="nav-dashboard" class="nav-item active">
        <span class="material-icons">grid_view</span><span>BERANDA</span>
      </button>
      <button onclick="navigate('warga')" id="nav-warga" class="nav-item">
        <span class="material-icons">person</span><span>WARGA</span>
      </button>
      <button onclick="openForm()" class="btn-add-center">
        <span class="material-icons">add</span>
      </button>
      <button onclick="navigate('kk')" id="nav-kk" class="nav-item">
        <span class="material-icons">groups</span><span>KELUARGA</span>
      </button>
      <button onclick="refreshData()" class="nav-item">
        <span class="material-icons">sync</span><span>UPDATE</span>
      </button>
    </nav>
  </div>

  <!-- FORM MODAL -->
  <div id="modal-form" class="modal" onclick="if(event.target == this) closeModal('form')">
    <div class="bg-white w-full max-w-2xl rounded-[2.5rem] overflow-hidden shadow-2xl mx-4 transform transition-all">
      <div class="p-6 border-b flex justify-between items-center bg-blue-600 text-white">
        <h3 id="form-title" class="font-bold">Input Data Warga</h3>
        <button onclick="closeModal('form')" class="text-white/70 hover:text-white"><span class="material-icons">close</span></button>
      </div>
      <form id="entry-form" class="p-6 space-y-6 max-h-[80vh] overflow-y-auto">
        <input type="hidden" id="f-original-nik">
        
        <!-- Identitas Utama -->
        <div class="space-y-4">
          <p class="text-xs font-black text-blue-600 uppercase tracking-widest border-b pb-2">Identitas Dasar</p>
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">NIK</label><input type="text" id="f-nik" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none" required></div>
            <div class="col-span-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">No KK</label><input type="text" id="f-kk" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none" required></div>
            <div class="col-span-2"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Nama Lengkap</label><input type="text" id="f-nama" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none" required></div>
            <div class="col-span-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Kelamin</label><select id="f-kelamin" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none"><option>Laki-Laki</option><option>Perempuan</option></select></div>
            <div class="col-span-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Agama</label><select id="f-agama" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none"><option>Islam</option><option>Kristen</option><option>Katolik</option><option>Buddha</option><option>Hindu</option><option>Konghucu</option></select></div>
          </div>
        </div>

        <!-- Kelahiran & Status -->
        <div class="space-y-4">
          <p class="text-xs font-black text-blue-600 uppercase tracking-widest border-b pb-2">Kelahiran & Status</p>
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Tempat Lahir</label><input type="text" id="f-tempat-lahir" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none"></div>
            <div class="col-span-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Tanggal Lahir</label><input type="date" id="f-tgl-lahir" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none"></div>
            <div class="col-span-2"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Status Perkawinan</label><select id="f-perkawinan" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none"><option>Belum kawin</option><option>Kawin</option><option>Cerai Hidup</option><option>Cerai Mati</option></select></div>
          </div>
        </div>

        <!-- Alamat -->
        <div class="space-y-4">
          <div class="flex justify-between items-center border-b pb-2">
            <p class="text-xs font-black text-blue-600 uppercase tracking-widest">Alamat Tinggal</p>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="sync-ktp" onchange="syncAlamatKTP()" class="w-4 h-4 rounded text-blue-600">
                <span class="text-[10px] font-bold text-slate-500 uppercase">Sama dengan KTP</span>
            </label>
          </div>
          <div class="grid grid-cols-3 gap-4">
            <div class="col-span-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Blok</label><select id="f-blok" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none"><option>A</option><option>B</option><option>B1</option><option>C</option><option>D</option><option>E</option><option>F</option><option>G</option></select></div>
            <div class="col-span-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">No</label><input type="text" id="f-nomer" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none"></div>
            <div class="col-span-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">RT</label><select id="f-rt" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none"><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
            <div class="col-span-3"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Alamat KTP Lengkap</label><textarea id="f-ktp-alamat" rows="2" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none" placeholder="Masukkan alamat sesuai KTP..."></textarea></div>
          </div>
        </div>

        <!-- Pekerjaan & Keluarga -->
        <div class="space-y-4">
          <p class="text-xs font-black text-blue-600 uppercase tracking-widest border-b pb-2">Profesi & Keluarga</p>
          <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2">
                <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Pekerjaan</label>
                <select id="f-pekerjaan" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none">
                    <option>Belum/Tidak Bekerja</option><option>Mengurus Rumah Tangga</option><option>Pelajar/Mahasiswa</option><option>Pensiunan</option><option>PNS</option><option>TNI</option><option>POLRI</option><option>Karyawan Swasta</option><option>Wiraswasta</option><option>Petani</option><option>Nelayan</option><option>Lainnya</option>
                </select>
            </div>
            <div class="col-span-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">No HP</label><input type="text" id="f-hp" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none"></div>
            <div class="col-span-1"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Status Keluarga</label><select id="f-status-kel" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none"><option>Kepala Keluarga</option><option>Istri</option><option>Anak</option><option>Orang Tua</option><option>Lainnya</option></select></div>
            <div class="col-span-2"><label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Status Tinggal</label><select id="f-tinggal" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-100 outline-none"><option>Tetap</option><option>Kontrak</option><option>Kos</option><option>Lainnya</option></select></div>
          </div>
        </div>

        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg mt-4 sticky bottom-0">SIMPAN DATA</button>
      </form>
    </div>
  </div>

  <!-- DETAIL MODAL -->
  <div id="modal-detail" class="modal" onclick="if(event.target == this) closeModal('detail')">
    <div class="bg-white w-full max-w-2xl rounded-[2.5rem] overflow-hidden shadow-2xl mx-4 max-h-[90vh] overflow-y-auto">
        <div id="detail-header" class="p-8 bg-blue-600 text-white relative flex flex-col items-center text-center">
            <button onclick="closeModal('detail')" class="absolute top-6 right-6 text-white/50"><span class="material-icons">close</span></button>
            <div class="w-24 h-24 bg-white/20 rounded-[2rem] flex items-center justify-center mb-4 border-4 border-white/10 shadow-inner">
                <span class="material-icons text-5xl text-white">account_circle</span>
            </div>
            <h2 id="d-nama" class="text-2xl font-extrabold mb-1 tracking-tight">Nama Warga</h2>
            <div class="px-4 py-1 bg-white/10 rounded-full text-[10px] font-bold uppercase tracking-widest" id="d-status-tag">STATUS</div>
        </div>
        
        <div class="p-6 md:p-10 space-y-8">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">NIK</p>
                    <p id="d-nik" class="text-sm font-bold text-slate-800 tracking-wider">-</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">No KK</p>
                    <p id="d-kk" class="text-sm font-bold text-slate-800 tracking-wider">-</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Blok/No - RT</p>
                    <p id="d-alamat" class="text-sm font-bold text-slate-800">-</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Kelamin</p>
                    <p id="d-kelamin" class="text-sm font-bold text-slate-800">-</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Agama</p>
                    <p id="d-agama" class="text-sm font-bold text-slate-800">-</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Lahir</p>
                    <p id="d-lahir" class="text-sm font-bold text-slate-800">-</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Perkawinan</p>
                    <p id="d-nikah" class="text-sm font-bold text-slate-800">-</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Pekerjaan</p>
                    <p id="d-kerja" class="text-sm font-bold text-slate-800">-</p>
                </div>
                <div class="detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Tinggal</p>
                    <p id="d-tinggal" class="text-sm font-bold text-slate-800">-</p>
                </div>
                <div class="col-span-2 md:col-span-3 detail-grid-item">
                    <p class="text-[9px] font-black text-slate-400 uppercase mb-1">Alamat KTP</p>
                    <p id="d-ktp" class="text-xs font-medium text-slate-600 leading-relaxed italic">-</p>
                </div>
            </div>

            <div class="flex gap-4">
                <button id="btn-edit" class="flex-1 bg-slate-100 text-slate-600 font-bold py-4 rounded-2xl flex items-center justify-center gap-2 hover:bg-slate-200"><span class="material-icons text-sm">edit</span> Edit</button>
                <button id="btn-wa" class="flex-1 bg-green-500 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-green-200"><span class="material-icons text-sm">message</span> WhatsApp</button>
            </div>
        </div>
    </div>
  </div>

  <!-- LOADING -->
  <div id="loading" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[400] hidden flex items-center justify-center">
    <div class="bg-white p-8 rounded-[2rem] shadow-2xl flex flex-col items-center">
        <div class="w-10 h-10 border-4 border-slate-100 border-t-blue-600 animate-spin rounded-full mb-3"></div>
        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Memproses...</p>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyQnIfaRQhv6r9jL_bJ3-uX9RhyUSAnUF4kt_lTCpgkHjWtXsCk4OWTBLPxB3JDz6L0qw/exec";
    let ALL_DATA = [];
    let CURRENT_FILTER_RT = 'all';
    let rtChart;

    const getVal = (obj, pattern) => {
      const keys = Object.keys(obj);
      const match = keys.find(k => k.toLowerCase().replace(/[^a-z]/g, '').includes(pattern.toLowerCase().replace(/[^a-z]/g, '')));
      return match ? obj[match] : "";
    };

    const clean = (v) => (v === undefined || v === null || v === "") ? "-" : String(v).trim();

    function syncAlamatKTP() {
        const isChecked = document.getElementById('sync-ktp').checked;
        if(isChecked) {
            const blok = document.getElementById('f-blok').value;
            const nomer = document.getElementById('f-nomer').value;
            const rt = document.getElementById('f-rt').value;
            document.getElementById('f-ktp-alamat').value = `Blok ${blok} No. ${nomer} RT 0${rt}`;
        }
    }

    async function callAPI(action, args = []) {
      const isPost = action === 'saveWarga';
      const options = {
        method: isPost ? 'POST' : 'GET',
        mode: 'cors',
        headers: isPost ? { 'Content-Type': 'text/plain;charset=utf-8' } : {}
      };
      let url = API_URL;
      if (isPost) options.body = JSON.stringify({ action, args });
      else url += `?action=${action}&args=${encodeURIComponent(JSON.stringify(args))}`;
      
      try {
        const response = await fetch(url, options);
        return await response.json();
      } catch (e) {
        return { success: false, error: "Koneksi Bermasalah" };
      }
    }

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      toggleLoading(true);
      const res = await callAPI('checkLogin', [document.getElementById('username').value, document.getElementById('password').value]);
      if(res && res.success) {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('main-app').classList.remove('hidden');
        await refreshData();
      } else alert("Akses Ditolak!");
      toggleLoading(false);
    });

    async function refreshData() {
      toggleLoading(true);
      const data = await callAPI('getAllWarga');
      if (Array.isArray(data)) {
        ALL_DATA = data;
        updateUI();
      }
      toggleLoading(false);
    }

    function updateUI() {
      const listKK = ALL_DATA.filter(w => {
          const status = clean(getVal(w, "Status Keluarga")).toLowerCase();
          return status.includes("kepala");
      });
      
      document.getElementById('stat-total').innerText = ALL_DATA.length;
      document.getElementById('stat-kk').innerText = listKK.length;
      
      let l = 0, p = 0;
      const rtStats = { "1":0, "2":0, "3":0, "4":0 };
      
      ALL_DATA.forEach(w => {
        const kel = clean(getVal(w, "Kelamin")).toLowerCase();
        if(kel.startsWith('l')) l++; else if(kel.startsWith('p')) p++;
        const rt = clean(getVal(w, "RT"));
        if(rtStats[rt] !== undefined) rtStats[rt]++;
      });

      document.getElementById('stat-l').innerText = l;
      document.getElementById('stat-p').innerText = p;

      renderChart(rtStats);
      renderRecent(ALL_DATA.slice(-5).reverse());
      renderKK(listKK);
      doSearch();
    }

    function renderRecent(list) {
        document.getElementById('recent-list').innerHTML = list.map(w => `
            <div onclick="viewDetail('${getVal(w, "NIK")}')" class="bg-white p-4 rounded-3xl border border-slate-100 flex items-center gap-3 active:scale-[0.98] transition-all">
                <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center font-bold text-xs">${clean(getVal(w, "Blok"))}</div>
                <div class="flex-1">
                    <p class="font-bold text-slate-800 text-sm">${getVal(w, "Nama")}</p>
                    <p class="text-[9px] text-slate-500 uppercase font-medium">${clean(getVal(w, "Blok"))}/${clean(getVal(w, "Nomer"))} - RT ${clean(getVal(w, "RT"))}</p>
                </div>
                <span class="material-icons text-slate-200 text-sm">chevron_right</span>
            </div>
        `).join('');
    }

    function renderKK(list) {
      if(list.length === 0) {
          document.getElementById('kk-list').innerHTML = `<div class="p-10 text-center text-slate-400 text-xs font-bold uppercase tracking-widest">Data Kepala Keluarga Tidak Ditemukan</div>`;
          return;
      }
      document.getElementById('kk-list').innerHTML = list.map(k => {
        const noKK = clean(getVal(k, "KK"));
        const members = ALL_DATA.filter(w => clean(getVal(w, "KK")) === noKK);
        return `
          <div class="kk-card bg-white p-5 rounded-[2rem] border border-slate-100 shadow-sm">
            <div class="flex items-center gap-4 cursor-pointer" onclick="this.parentElement.classList.toggle('open')">
              <div class="bg-blue-600 text-white w-10 h-10 rounded-xl flex items-center justify-center font-bold text-xs">${clean(getVal(k, "Blok"))}</div>
              <div class="flex-1 min-w-0">
                <p class="font-bold text-slate-800 text-sm truncate">${getVal(k, "Nama")}</p>
                <p class="text-[10px] text-slate-500 mt-0.5 font-medium">KK: ${noKK} â€” Blok ${clean(getVal(k, "Blok"))}/${clean(getVal(k, "Nomer"))}</p>
              </div>
              <span class="material-icons text-slate-300">expand_more</span>
            </div>
            <div class="kk-members"><div class="space-y-2 mt-4">
              ${members.map(m => `<div onclick="viewDetail('${getVal(m, "NIK")}')" class="bg-slate-50 p-3 rounded-xl text-xs font-bold text-slate-700 flex justify-between active:scale-95 transition-all">
                <span>${getVal(m, "Nama")}</span><span class="text-[9px] text-slate-400 font-normal uppercase tracking-tighter">${clean(getVal(m, "Status Keluarga"))}</span>
              </div>`).join('')}
            </div></div>
          </div>
        `;
      }).join('');
    }

    function filterRT(rt) {
        CURRENT_FILTER_RT = rt;
        document.querySelectorAll('.chip-filter').forEach(c => c.classList.remove('active'));
        document.getElementById('chip-'+rt).classList.add('active');
        doSearch();
    }

    function doSearch() {
      const q = document.getElementById('search').value.toLowerCase();
      const filtered = ALL_DATA.filter(w => {
          const matchSearch = getVal(w, "Nama").toLowerCase().includes(q) || getVal(w, "NIK").toString().includes(q);
          const matchRT = CURRENT_FILTER_RT === 'all' || clean(getVal(w, "RT")) === CURRENT_FILTER_RT;
          return matchSearch && matchRT;
      });
      document.getElementById('warga-list').innerHTML = filtered.map(w => `
        <div onclick="viewDetail('${getVal(w, "NIK")}')" class="bg-white p-4 rounded-3xl border border-slate-100 flex items-center gap-4 active:scale-95 transition-all">
          <div class="w-12 h-12 bg-slate-100 rounded-2xl flex items-center justify-center font-bold text-slate-400 text-xs">${clean(getVal(w, "Blok"))}</div>
          <div class="flex-1">
            <p class="font-bold text-slate-800 text-sm">${getVal(w, "Nama")}</p>
            <p class="text-[10px] text-slate-400 font-medium">${getVal(w, "NIK")}</p>
          </div>
          <div class="text-right"><span class="text-[10px] font-black text-blue-600">RT ${clean(getVal(w, "RT"))}</span></div>
        </div>
      `).join('');
    }

    function doSearchKK() {
        const q = document.getElementById('search-kk').value.toLowerCase();
        const listKK = ALL_DATA.filter(w => {
            const status = clean(getVal(w, "Status Keluarga")).toLowerCase();
            const nama = getVal(w, "Nama").toLowerCase();
            return status.includes("kepala") && nama.includes(q);
        });
        renderKK(listKK);
    }

    function viewDetail(nik) {
        const w = ALL_DATA.find(x => String(getVal(x, "NIK")) === String(nik));
        if(!w) return;
        
        document.getElementById('d-nama').innerText = getVal(w, "Nama");
        document.getElementById('d-nik').innerText = getVal(w, "NIK");
        document.getElementById('d-kk').innerText = getVal(w, "KK");
        document.getElementById('d-alamat').innerText = `${clean(getVal(w, "Blok"))}/${clean(getVal(w, "Nomer"))} - RT 0${clean(getVal(w, "RT"))}`;
        document.getElementById('d-status-tag').innerText = clean(getVal(w, "Status Keluarga"));
        document.getElementById('d-kelamin').innerText = clean(getVal(w, "Kelamin"));
        document.getElementById('d-agama').innerText = clean(getVal(w, "Agama"));
        document.getElementById('d-lahir').innerText = `${clean(getVal(w, "Tempat Lahir"))}, ${clean(getVal(w, "Tanggal Lahir"))}`;
        document.getElementById('d-nikah').innerText = clean(getVal(w, "Status Perkawinan"));
        document.getElementById('d-kerja').innerText = clean(getVal(w, "Pekerjaan"));
        document.getElementById('d-tinggal').innerText = clean(getVal(w, "Status Tinggal"));
        document.getElementById('d-ktp').innerText = clean(getVal(w, "Alamat KTP"));
        
        document.getElementById('btn-wa').onclick = () => {
            const hp = clean(getVal(w, "HP"));
            if(hp !== "-" && hp.length > 5) window.open(`https://wa.me/${hp.replace(/^0/, '62')}`, '_blank');
            else alert("Nomor HP tidak valid/tersedia");
        };

        document.getElementById('btn-edit').onclick = () => {
            closeModal('detail');
            openForm(w);
        };
        
        document.getElementById('modal-detail').classList.add('active');
    }

    function openForm(editData = null) {
      const f = document.getElementById('entry-form');
      f.reset();
      document.getElementById('f-original-nik').value = "";
      document.getElementById('form-title').innerText = "Input Data Warga";
      document.getElementById('sync-ktp').checked = false;
      
      if(editData) {
        document.getElementById('form-title').innerText = "Edit Data Warga";
        document.getElementById('f-original-nik').value = getVal(editData, "NIK");
        document.getElementById('f-nik').value = getVal(editData, "NIK");
        document.getElementById('f-kk').value = getVal(editData, "KK");
        document.getElementById('f-nama').value = getVal(editData, "Nama");
        document.getElementById('f-kelamin').value = getVal(editData, "Kelamin");
        document.getElementById('f-agama').value = getVal(editData, "Agama");
        document.getElementById('f-tempat-lahir').value = getVal(editData, "Tempat Lahir");
        document.getElementById('f-tgl-lahir').value = getVal(editData, "Tanggal Lahir");
        document.getElementById('f-perkawinan').value = getVal(editData, "Status Perkawinan");
        document.getElementById('f-blok').value = getVal(editData, "Blok");
        document.getElementById('f-nomer').value = getVal(editData, "Nomer");
        document.getElementById('f-rt').value = getVal(editData, "RT");
        document.getElementById('f-ktp-alamat').value = getVal(editData, "Alamat KTP");
        document.getElementById('f-pekerjaan').value = getVal(editData, "Pekerjaan");
        document.getElementById('f-hp').value = getVal(editData, "HP");
        document.getElementById('f-tinggal').value = getVal(editData, "Status Tinggal");
        document.getElementById('f-status-kel').value = getVal(editData, "Status Keluarga");
      }
      document.getElementById('modal-form').classList.add('active');
    }

    document.getElementById('entry-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        toggleLoading(true);

        const blok = document.getElementById('f-blok').value;
        const nomer = document.getElementById('f-nomer').value;
        const rt = document.getElementById('f-rt').value;

        // PERBAIKAN: Kunci data harus sesuai dengan payload di code.gs
        const data = {
            nik: document.getElementById('f-nik').value,
            kk: document.getElementById('f-kk').value,
            nama: document.getElementById('f-nama').value,
            kelamin: document.getElementById('f-kelamin').value,
            agama: document.getElementById('f-agama').value,
            tempat: document.getElementById('f-tempat-lahir').value, // Sesuai case 'tempat lahir': return payload.tempat;
            tanggal: document.getElementById('f-tgl-lahir').value, // Sesuai case 'tanggal lahir': return payload.tanggal;
            perkawinan: document.getElementById('f-perkawinan').value,
            blok: blok,
            nomer: nomer,
            rt: rt,
            alamatKTP: document.getElementById('f-ktp-alamat').value, // Sesuai case 'alamat ktp': return payload.alamatKTP;
            alamatTinggal: `Blok ${blok}/${nomer} RT 0${rt}`,
            pekerjaan: document.getElementById('f-pekerjaan').value,
            hp: document.getElementById('f-hp').value,
            tinggal: document.getElementById('f-tinggal').value,
            statusKel: document.getElementById('f-status-kel').value,
            originalNik: document.getElementById('f-original-nik').value
        };

        const res = await callAPI('saveWarga', [data]);
        if(res.success) {
            closeModal('form');
            await refreshData();
        } else {
            alert("Gagal Simpan: " + res.error);
        }
        toggleLoading(false);
    });

    function navigate(p) {
      document.querySelectorAll('.page').forEach(e => e.classList.toggle('active', e.id === 'page-'+p));
      document.querySelectorAll('.nav-item').forEach(e => e.classList.toggle('active', e.id === 'nav-'+p));
    }
    function logout() { location.reload(); }
    function closeModal(id) { document.getElementById('modal-'+id).classList.remove('active'); }
    function toggleLoading(s) { document.getElementById('loading').classList.toggle('hidden', !s); }

    function renderChart(rtData) {
      const ctx = document.getElementById('chartRT').getContext('2d');
      if(rtChart) rtChart.destroy();
      rtChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: ['RT 01', 'RT 02', 'RT 03', 'RT 04'], datasets: [{ data: [rtData["1"], rtData["2"], rtData["3"], rtData["4"]], backgroundColor: '#2563eb', borderRadius: 10 }] },
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { legend: { display: false } }, 
            scales: { 
                y: { beginAtZero: true, grid: { display: false }, ticks: { font: { size: 10 } } },
                x: { grid: { display: false }, ticks: { font: { size: 10, weight: 'bold' } } }
            } 
        }
      });
    }
  </script>
</body>
</html>
