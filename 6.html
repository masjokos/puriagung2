<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Data Warga</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
    .page { display: none; padding-bottom: 100px; }
    .page.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .modal { display: none; position: fixed; z-index: 50; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 1rem; }
    .modal.active { display: flex; }
  </style>
</head>
<body class="bg-slate-50">

  <!-- HALAMAN LOGIN -->
  <div id="login-page" class="fixed inset-0 bg-white z-[100] flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-3xl shadow-2xl p-8 border border-slate-100 text-center">
      <div class="bg-blue-600 text-white w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6">
        <span class="material-icons text-5xl">location_city</span>
      </div>
      <h2 class="text-3xl font-black text-slate-800">E-Warga</h2>
      <p class="text-slate-500 mt-2 mb-8">Silakan masuk untuk akses data</p>
      <form id="login-form" class="space-y-4 text-left">
        <input type="text" id="username" placeholder="Username" class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none" required>
        <input type="password" id="password" placeholder="Password" class="w-full px-5 py-4 rounded-2xl bg-slate-50 border border-slate-200 outline-none" required>
        
        <div id="api-error-box" class="hidden p-4 bg-amber-50 border border-amber-200 rounded-2xl text-left mb-4">
          <p class="text-amber-700 text-xs font-bold flex items-center gap-2">
            <span class="material-icons text-sm">warning</span> Koneksi API Terhambat
          </p>
          <p class="text-amber-600 text-[10px] mt-1">Browser memblokir akses ke Google Script (CORS). Klik tombol di bawah untuk mencoba fitur dengan data contoh.</p>
          <button type="button" onclick="activateDemoMode()" class="mt-2 w-full py-2 bg-amber-500 text-white text-[10px] font-black rounded-lg">AKTIFKAN MODE DEMO</button>
        </div>

        <div id="login-error" class="hidden p-4 bg-red-50 text-red-600 text-sm rounded-xl mb-4"></div>
        <button type="submit" id="login-btn" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-blue-700 transition-colors">Masuk</button>
      </form>
    </div>
  </div>

  <!-- KONTEN APLIKASI UTAMA -->
  <div id="main-app" class="hidden min-h-screen">
    <header class="bg-white border-b sticky top-0 z-40 px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-2">
        <span class="material-icons text-blue-600">analytics</span>
        <h1 class="font-bold text-slate-800">E-Warga</h1>
        <span id="badge-demo" class="hidden px-2 py-0.5 bg-amber-100 text-amber-700 text-[9px] font-black rounded-md">DEMO</span>
      </div>
      <nav class="flex gap-2">
        <button onclick="navigate('dashboard')" class="p-2 rounded-xl hover:bg-slate-100" title="Dashboard"><span class="material-icons">dashboard</span></button>
        <button onclick="navigate('datawarga')" class="p-2 rounded-xl hover:bg-slate-100" title="Data Warga"><span class="material-icons">people</span></button>
        <button onclick="navigate('kk')" class="p-2 rounded-xl hover:bg-slate-100" title="Data KK"><span class="material-icons">groups</span></button>
        <button onclick="logout()" class="p-2 rounded-xl text-red-500 hover:bg-red-50" title="Keluar"><span class="material-icons">logout</span></button>
      </nav>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8">
      <!-- DASHBOARD -->
      <section id="page-dashboard" class="page active">
        <h2 class="text-2xl font-black mb-6">Dashboard Ringkasan</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
             <h4 class="font-bold mb-4">Statistik Gender</h4>
             <div class="h-64"><canvas id="chartGender"></canvas></div>
          </div>
          <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
             <h4 class="font-bold mb-4">Statistik RT</h4>
             <div class="h-64"><canvas id="chartRT"></canvas></div>
          </div>
        </div>
      </section>

      <!-- DATA WARGA -->
      <section id="page-datawarga" class="page">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-black">Data Warga</h2>
          <button onclick="openForm()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-bold flex items-center gap-2">
            <span class="material-icons">add</span> Tambah
          </button>
        </div>
        <div class="mb-6">
          <input type="text" id="search-input" oninput="filterData()" placeholder="Cari warga..." class="w-full px-6 py-4 bg-white rounded-2xl border-none shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div id="warga-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
      </section>

      <!-- KK -->
      <section id="page-kk" class="page">
        <h2 class="text-2xl font-black mb-6">Data Kepala Keluarga</h2>
        <div id="kk-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
      </section>
    </main>
  </div>

  <!-- MODAL FORM -->
  <div id="modal-form" class="modal">
    <div class="bg-white w-full max-w-4xl rounded-[2.5rem] overflow-hidden max-h-[95vh] flex flex-col shadow-2xl">
      <div class="px-8 py-6 border-b flex justify-between items-center">
        <h3 id="form-title" class="text-xl font-black">Form Data Warga</h3>
        <button onclick="closeModal('modal-form')" class="material-icons">close</button>
      </div>
      <form id="warga-form" class="p-8 overflow-y-auto space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="space-y-4">
             <input type="number" name="NIK" placeholder="NIK" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-100" required>
             <input type="number" name="NO_KK" placeholder="Nomor KK" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-100" required>
             <input type="text" name="Nama" placeholder="Nama Lengkap" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-100" required>
             <select name="Kelamin" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-100">
               <option>Laki-Laki</option><option>Perempuan</option>
             </select>
          </div>
          <div class="space-y-4">
             <div class="grid grid-cols-3 gap-2">
               <select name="Blok" id="form-blok" onchange="autoFillAlamat()" class="px-3 py-3 rounded-xl bg-slate-50 border border-slate-100">
                 <option>A</option><option>B</option><option>C</option><option>D</option>
               </select>
               <input type="text" name="Nomer" id="form-nomer" oninput="autoFillAlamat()" placeholder="No" class="px-3 py-3 rounded-xl bg-slate-50 border border-slate-100">
               <select name="RT" id="form-rt" onchange="autoFillAlamat()" class="px-3 py-3 rounded-xl bg-slate-50 border border-slate-100">
                 <option>1</option><option>2</option><option>3</option><option>4</option>
               </select>
             </div>
             <select name="Pekerjaan" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-100 outline-none">
               <option value="Belum/Tidak Bekerja">Belum/Tidak Bekerja</option>
               <option value="Mengurus Rumah Tangga">Mengurus Rumah Tangga</option>
               <option value="Pelajar/Mahasiswa">Pelajar/Mahasiswa</option>
               <option value="Pensiunan">Pensiunan</option>
               <option value="PNS">PNS</option>
               <option value="TNI">TNI</option>
               <option value="POLRI">POLRI</option>
               <option value="Karyawan Swasta">Karyawan Swasta</option>
               <option value="Wiraswasta">Wiraswasta</option>
               <option value="Petani">Petani</option>
               <option value="Nelayan">Nelayan</option>
             </select>
             <select name="Status_Keluarga" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-100">
               <option>Kepala Keluarga</option><option>Istri</option><option>Anak</option><option>Orang Tua</option>
             </select>
             <textarea name="Alamat_KTP" id="form-alamatktp" placeholder="Alamat KTP" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-100 h-20"></textarea>
          </div>
        </div>
        <div class="flex flex-col gap-4">
          <input type="file" id="photo-input" accept="image/*" class="text-sm">
          <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">SIMPAN DATA</button>
        </div>
      </form>
    </div>
  </div>

  <!-- LOADING OVERLAY -->
  <div id="loading" class="fixed inset-0 bg-white/60 backdrop-blur-md z-[200] hidden flex-col items-center justify-center">
    <div class="loader mb-4"></div>
    <p class="text-xs font-black text-slate-400" id="loading-text">MEMPROSES...</p>
    <button id="cancel-loading" onclick="showLoading(false)" class="mt-4 text-[10px] text-red-500 font-bold hidden underline">BATALKAN</button>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyQnIfaRQhv6r9jL_bJ3-uX9RhyUSAnUF4kt_lTCpgkHjWtXsCk4OWTBLPxB3JDz6L0qw/exec";
    
    let ALL_DATA = [];
    let genderChart, rtChart;
    let IS_DEMO_MODE = false;

    /**
     * FUNGSI KRUSIAL: Menjalankan backend menggunakan Fetch API dengan fallback Mode Demo.
     */
    async function runBackend(functionName, args = []) {
      if (IS_DEMO_MODE) return getDemoData(functionName);

      try {
        const params = new URLSearchParams({
          action: functionName,
          args: JSON.stringify(args)
        });

        // Menggunakan Fetch API sebagai pengganti JSONP yang diblokir
        const response = await fetch(`${API_URL}?${params.toString()}`, {
          method: 'GET',
          mode: 'cors', // Pastikan Apps Script mengizinkan CORS
          cache: 'no-cache'
        });

        if (!response.ok) throw new Error("Respons Server Tidak Ok");
        return await response.json();
      } catch (err) {
        console.error("Fetch Error:", err);
        document.getElementById('api-error-box').classList.remove('hidden');
        throw err;
      }
    }

    function activateDemoMode() {
      IS_DEMO_MODE = true;
      document.getElementById('api-error-box').classList.add('hidden');
      document.getElementById('badge-demo').classList.remove('hidden');
      alert("Mode Demo Diaktifkan. Anda dapat mencoba aplikasi dengan data contoh.");
    }

    function getDemoData(action) {
      if (action === 'checkLogin') return { success: true };
      if (action === 'getAllWarga') return [
        { NIK: "3201010101010001", Nama: "Rian Hidayat", RT: "01", Pekerjaan: "Karyawan", Status_Keluarga: "Kepala Keluarga", NO_KK: "KK001", Kelamin: "Laki-Laki" },
        { NIK: "3201010101010002", Nama: "Lina Marlina", RT: "01", Pekerjaan: "IRT", Status_Keluarga: "Istri", NO_KK: "KK001", Kelamin: "Perempuan" },
        { NIK: "3201010101010003", Nama: "Dadang Sudrajat", RT: "02", Pekerjaan: "Wiraswasta", Status_Keluarga: "Kepala Keluarga", NO_KK: "KK002", Kelamin: "Laki-Laki" }
      ];
      return { success: true };
    }

    document.getElementById('login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const loginError = document.getElementById('login-error');
      loginError.classList.add('hidden');
      
      showLoading(true, "MENGHUBUNGKAN KE CLOUD...");

      const user = document.getElementById('username').value;
      const pass = document.getElementById('password').value;

      try {
        const res = await runBackend('checkLogin', [user, pass]);
        if(res === true || (res && res.success)) {
          enterApp();
        } else {
          loginError.innerText = "Kredensial salah.";
          loginError.classList.remove('hidden');
          showLoading(false);
        }
      } catch (err) {
        showLoading(false);
        // Error sudah ditangani di runBackend (menampilkan error box)
      }
    });

    function enterApp() {
      document.getElementById('login-page').style.display = 'none';
      document.getElementById('main-app').classList.remove('hidden');
      refreshData();
    }

    async function refreshData() {
      showLoading(true, "SINKRONISASI DATA...");
      try {
        const res = await runBackend('getAllWarga');
        ALL_DATA = Array.isArray(res) ? res : (res && res.data ? res.data : []);
        renderWarga();
        renderKK();
        updateCharts();
      } catch (e) {
        console.error("Refresh Error:", e);
      }
      showLoading(false);
    }

    function renderWarga(filter = null) {
      const list = filter || ALL_DATA;
      const container = document.getElementById('warga-list');
      if (!list.length) {
        container.innerHTML = '<div class="col-span-full text-center py-20 text-slate-400 font-medium italic">Data tidak ditemukan</div>';
        return;
      }
      container.innerHTML = list.map(w => `
        <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer" onclick="openForm('${w.NIK}')">
          <div class="flex justify-between items-start mb-2">
            <h4 class="font-bold text-slate-800 leading-tight">${w.Nama || 'N/A'}</h4>
            <span class="text-[10px] font-black text-slate-300">#${String(w.NIK || '0000').slice(-4)}</span>
          </div>
          <p class="text-[11px] text-slate-400 font-medium mb-4 italic">${w.NIK || '-'}</p>
          <div class="flex flex-wrap gap-1">
            <span class="px-2 py-1 bg-blue-50 text-[9px] font-black text-blue-600 rounded-lg">RT ${w.RT || '0'}</span>
            <span class="px-2 py-1 bg-slate-50 text-[9px] font-black text-slate-500 rounded-lg uppercase">${w.Pekerjaan || 'UMUM'}</span>
          </div>
        </div>
      `).join('');
    }

    function renderKK() {
      const heads = ALL_DATA.filter(w => w.Status_Keluarga === 'Kepala Keluarga');
      const container = document.getElementById('kk-list');
      if (!heads.length) {
        container.innerHTML = '<div class="col-span-full text-center py-20 text-slate-400">Data KK belum tersedia</div>';
        return;
      }
      container.innerHTML = heads.map(h => {
        const members = ALL_DATA.filter(w => w.NO_KK === h.NO_KK && w.NIK !== h.NIK);
        return `
          <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 font-black text-xs">KK</div>
              <div>
                <h3 class="font-black text-slate-800">${h.Nama}</h3>
                <p class="text-[10px] text-slate-400 font-bold tracking-widest">NO. ${h.NO_KK || '-'}</p>
              </div>
            </div>
            <div class="space-y-1">
              ${members.length ? members.map(m => `
                <div class="p-3 bg-slate-50 rounded-2xl text-[11px] font-bold flex justify-between items-center">
                  <span class="text-slate-700">${m.Nama}</span>
                  <span class="px-2 py-0.5 bg-white text-[9px] text-slate-400 rounded-md border border-slate-100 uppercase">${m.Status_Keluarga}</span>
                </div>`).join('') : '<p class="text-[10px] text-slate-300 italic py-2">Satu anggota</p>'}
            </div>
          </div>
        `;
      }).join('');
    }

    async function updateCharts() {
      const stats = { gender: { 'Laki-Laki': 0, 'Perempuan': 0 }, rt: {} };
      ALL_DATA.forEach(w => { 
        if(w.Kelamin && stats.gender.hasOwnProperty(w.Kelamin)) stats.gender[w.Kelamin]++;
        if(w.RT) stats.rt[w.RT] = (stats.rt[w.RT] || 0) + 1; 
      });
      drawCharts(stats);
    }

    function drawCharts(stats) {
      const config = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10, weight: 'bold' } } } } };
      if(genderChart) genderChart.destroy();
      genderChart = new Chart(document.getElementById('chartGender'), {
        type: 'doughnut',
        data: { labels: Object.keys(stats.gender), datasets: [{ data: Object.values(stats.gender), backgroundColor: ['#3b82f6', '#ec4899'], borderWeight: 0, cutout: '70%' }] },
        options: config
      });
      if(rtChart) rtChart.destroy();
      rtChart = new Chart(document.getElementById('chartRT'), {
        type: 'bar',
        data: { labels: Object.keys(stats.rt).map(r => 'RT ' + r), datasets: [{ label: 'Warga', data: Object.values(stats.rt), backgroundColor: '#6366f1', borderRadius: 8 }] },
        options: config
      });
    }

    function openForm(nik = null) {
      const form = document.getElementById('warga-form');
      form.reset();
      document.getElementById('form-title').innerText = nik ? "Sunting Data Warga" : "Tambah Warga Baru";
      if(nik) {
        const w = ALL_DATA.find(x => x.NIK == nik);
        if (w) { Object.keys(w).forEach(key => { const field = form.querySelector(`[name="${key}"]`); if(field) field.value = w[key]; }); }
      }
      document.getElementById('modal-form').classList.add('active');
    }

    function autoFillAlamat() {
      const blok = document.getElementById('form-blok').value;
      const no = document.getElementById('form-nomer').value;
      const rt = document.getElementById('form-rt').value;
      document.getElementById('form-alamatktp').value = `Blok ${blok}/${no} RT ${rt}`;
    }

    document.getElementById('warga-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = {};
      new FormData(this).forEach((v, k) => formData[k] = v);
      showLoading(true, "MENYIMPAN...");
      try {
        const res = await runBackend('saveWarga', [formData]);
        if(res && res.success) { closeModal('modal-form'); refreshData(); }
        else { alert("Gagal menyimpan."); showLoading(false); }
      } catch (err) { showLoading(false); }
    });

    function filterData() {
      const q = document.getElementById('search-input').value.toLowerCase();
      const filtered = ALL_DATA.filter(w => (w.Nama && w.Nama.toLowerCase().includes(q)) || (w.NIK && String(w.NIK).includes(q)));
      renderWarga(filtered);
    }

    function navigate(p) {
      document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
      document.getElementById('page-' + p).classList.add('active');
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showLoading(s, text = "MEMPROSES...") { 
      const el = document.getElementById('loading');
      el.style.display = s ? 'flex' : 'none'; 
      document.getElementById('loading-text').innerText = text;
    }
    function logout() { location.reload(); }
  </script>
</body>
</html>
